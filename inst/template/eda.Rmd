---
title: "EDA"
output: html_document
date: "`r Sys.Date()`"
params:
  dm: dm
  data_tbl: data_tbl
  year: year
editor_options: 
  chunk_output_type: console
---

```{r echo=FALSE}
year <- params$year
if (is.null(year)) {
  rlang::abort(
    c(
      "Cannot render without a year.",
      i = "Did you call `render_report('eda.Rmd', .year = 2019)`?"
    )
  )
}
```

```{r echo=FALSE}
dm <- params$dm
data_tbl <- params$data_tbl
```

```{r setup, include=FALSE}
library(tidyverse)
library(corrr)
pkgload::load_all()
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, fig.align = "center", message = FALSE, warning = FALSE)
```

The chosen year is `r params$year`.

## Data model

```{r}
dm::dm_draw(dm)
```

## Data

```{r}
tbl <- 
  data_tbl |> 
  compute_dx_gap() |>
  mutate(pop_100k = pop_total / 1e5) |>
  mutate(is_hbc = as.character(is_hbc)) |> 
  select(-year, -country)
```

```{r eval=FALSE}
tbl |> 
  arrange(is_hbc, country_code) |> 
  gt::gt()
```

```{r}
tbl |> 
  pivot_longer(-c(country_code, is_hbc), names_to = "variable_name") |> 
  left_join(dxgap_master_list, join_by(variable_name)) |> 
  group_by(variable_name, definition, dataset) |> 
  summarise(
    n = n(), 
    n_missing = sum(is.na(value)),
    complete_rate = sum(!is.na(value)) / n, 
    .groups = "drop"
  ) |>
  mutate(complete_rate = round(complete_rate, 2)) |> 
  relocate(dataset, definition, variable_name) |> 
  arrange(dataset, variable_name) |> 
  select(-n) |> 
  gt::gt()
```


```{r eval=FALSE}
tbl |> 
  skimr::skim()
```


## Correlations

```{r}
corr_df_raw <- 
  tbl |> 
  select(-country_code) |> 
  correlate() 
```

```{r}
corr_df <- 
  corr_df_raw |> 
  select(term, who_dx_gap) |>
  arrange(who_dx_gap) |>
  filter(term != "who_dx_gap") |> 
  rename(who_dx_gap_all = who_dx_gap)
```


```{r}
corr_by_type <- 
  tbl |> 
  select(-country_code) |> 
  group_split(is_hbc) |> 
  map(correlate) |> 
  set_names(c("non_hbc", "hbc")) |> 
  map(~ select(.x, term, who_dx_gap)) |>
  map(~ arrange(.x, who_dx_gap)) |>
  map(~ filter(.x, term != "who_dx_gap"))
```


```{r}
corr_hbc <- 
  corr_by_type$hbc |> 
  rename(who_dx_gap_hbc = who_dx_gap)
corr_non_hbc <- 
  corr_by_type$non_hbc |> 
  rename(who_dx_gap_non_hbc = who_dx_gap)
```


```{r}
corr_all_df <- 
  corr_df |> 
  left_join(corr_hbc, join_by(term)) |> 
  left_join(corr_non_hbc, join_by(term)) |> 
  left_join(
    select(dxgap_master_list, variable_name, definition), 
    by = join_by(term == variable_name)
  ) |> 
  relocate(definition, term, starts_with("who_dx_gap"))
```

```{r fig.height=12, fig.width=12}
corr_all_df |> 
  pivot_longer(
    starts_with("who_dx_gap"), 
    names_to = "corr_cat", 
    values_to = "corr"
  ) |> 
  # mutate(term = forcats::fct_reorder(term, corr, .na_rm = FALSE)) |> 
  mutate(term = forcats::fct_relevel(term, sort)) |> 
  mutate(corr_cat = forcats::fct_relevel(
    corr_cat, 
    c("who_dx_gap_non_hbc", "who_dx_gap_all", "who_dx_gap_hbc"))
  ) |> 
  ggplot(aes(term, corr)) +
  geom_col() +
  coord_flip() +
  theme_minimal() +
  facet_wrap(vars(corr_cat))
```


```{r}
corr_all_df |> 
  arrange(term) |> 
  gt::gt()
```

```{r fig.height=15, fig.width=15}
corr_df_raw |> 
  plot_corr()
```


## Dx Gap

The Dx Gap is computed as follows:

$who\_dx\_gap = (e\_inc\_num - c\_newinc) / e\_inc\_num$

```{r fig.height=12, fig.width=12}
tbl |> 
  # mutate(country_code = forcats::fct_reorder(country_code, who_dx_gap, .na_rm = FALSE)) |> 
  mutate(country_code = forcats::fct_relevel(country_code, sort)) |> 
  ggplot(aes(country_code, who_dx_gap, fill = is_hbc)) +
  geom_col() +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = rel(0.45))) +
  coord_flip() +
    labs(
    y = paste("Dx Gap in", params$year),
    caption = "Source: WHO"
  ) +
  facet_wrap(vars(is_hbc), scales = "free") 
```

```{r}
plot_density(
  tbl,
  who_dx_gap,
  is_hbc,
  params$year,
  "Dx Gap in",
  "Source: WHO"
) +
  scale_x_continuous(labels = scales::label_percent(scale = 1))
```


```{r}
tbl |> 
  ggplot(aes(c_cdr, who_dx_gap, color = is_hbc)) +
  geom_point(alpha = .5, size = 0.75) +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  scale_x_continuous(labels = scales::label_percent(scale = 1)) +
  coord_fixed() +
  theme_minimal()
```

```{r long}
tbl <- 
  tbl |> 
  pivot_longer(cols = -c(is_hbc, country_code), names_to = "variable_name")
```

## Population total

```{r}
plot_density(
  tbl,
  pop_100k,
  is_hbc,
  params$year,
  "Total population in",
  "Source: World Bank"
)
```


## Population density

### Density distrbution

```{asis, echo=eval_if(params$data_tbl, "pop_density")}
tbl |>
  filter(variable_name == "pop_density") |>
  plot_density(
    tbl,
    value,
    is_hbc,
    params$year,
    "Population density (people per sq. km of land area) in",
    "Source: World Bank"
  )
```

### Dx Gap

```{asis, echo=eval_if(params$data_tbl, "pop_density")}
tbl |>
  filter(variable_name %in% c("pop_density", "who_dx_gap")) |>
  pivot_wider(names_from = variable_name, values_from = value) |> 
  plot_scatter(
    pop_density, 
    who_dx_gap, 
    params$year, 
    is_hbc, 
    "Population density (people per sq. km of land area) in", 
    "Source: World Bank"
  )
```

## Population urban

### Density distribution

```{asis, echo=eval_if(params$data_tbl, "pop_urban_perc")}
tbl |>
  filter(variable_name == "pop_urban_perc") |>
  plot_density(
    tbl,
    value,
    is_hbc,
    params$year,
    "Urban population (% of total population) in",
    "Source: World Bank"
  ) +
    scale_x_continuous(labels = scales::label_percent(scale = 1)) 
```

### Dx Gap

```{asis, echo=eval_if(params$data_tbl, "pop_urban_perc")}
tbl |>
  filter(variable_name %in% c("pop_urban_perc", "who_dx_gap")) |>
  pivot_wider(names_from = variable_name, values_from = value) |> 
  plot_scatter(
    pop_urban_perc,
    who_dx_gap,
    params$year,
    is_hbc,
    "Urban population (% of total population) in",
    "Source: World Bank"
  ) +
    scale_x_continuous(labels = scales::label_percent(scale = 1)) +
    coord_fixed()
```

## GDP

### Density distribution

```{asis, echo=eval_if(params$data_tbl, "gdp")}
tbl |> 
  filter(variable_name == "gdp") |>
  plot_density(
    value,
    is_hbc,
    params$year,
    "GDP (current US$) in",
    "Source: World Bank"
  ) 
```

### Dx Gap

```{asis, echo=eval_if(params$data_tbl, "gdp")}
tbl |>
  filter(variable_name %in% c("gdp", "who_dx_gap")) |>
  pivot_wider(names_from = variable_name, values_from = value) |>
  plot_scatter(
    gdp,
    who_dx_gap,
    params$year,
    is_hbc,
    "GDP (current US$) in",
    "Source: World Bank"
  )
```

## Budget

```{r}
budget_master <- 
  dxgap_master_list |> 
  filter(dataset == "budget") |> 
  select(variable_name, definition)

budget_cols <- 
  budget_master |> 
  pull(variable_name)
```

```{r}
budget_long <- 
  tbl |>
  select(country_code, is_hbc, who_dx_gap, pop_100k, all_of(budget_cols)) |> 
  pivot_longer(
    cols = all_of(budget_cols), 
    names_to = "budget_type", 
    values_to = "budget_value"
  ) |> 
  mutate(budget_per_100k = budget_value / pop_100k) |> 
  left_join(budget_master, join_by(budget_type == variable_name)) |> 
  mutate(definition = str_squish(str_remove(definition, "\\(.+\\)")))
```


### Density distribution

```{r fig.height=15, fig.width=12}
plot_density(
  budget_long,
  budget_per_100k,
  is_hbc,
  params$year,
  "Budget data in",
  "Source: Global Fund"
) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") 
```

### Dx Gap

```{r fig.height=15, fig.width=12}
plot_scatter(
  budget_long,
  budget_per_100k,
  who_dx_gap,
  params$year,
  is_hbc,
  "Budget data in",
  "Source: WHO"
) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") 
```

```{r eval=FALSE}
budget_long_log <- 
  tbl |>
  select(country_code, who_dx_gap, pop_100k, all_of(budget_cols)) |> 
  pivot_longer(
    cols = all_of(budget_cols), 
    names_to = "variable_name", 
    values_to = "budget_value"
  ) |> 
  transmute(
    country_code,
    variable_name,
    budget_per_100k = budget_value / pop_100k,
    log_budget_per_100k = log(budget_per_100k),
    who_dx_gap
  ) |> 
  left_join(budget_master, join_by(variable_name)) |> 
  mutate(definition = str_squish(str_remove(definition, "\\(.+\\)")))
```

```{r eval=FALSE, fig.height=15, fig.width=12}
budget_long_log |>
  ggplot(aes(log_budget_per_100k)) +
  geom_density(fill = "steelblue", alpha = .5) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

```{r eval=FALSE, fig.height=15, fig.width=12}
budget_long_log |>
  ggplot(aes(log_budget_per_100k, who_dx_gap)) +
  geom_point(colour = "steelblue", alpha = .8) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

## Community

```{r}
comm_master <- 
  dxgap_master_list |> 
  filter(dataset == "community_engagement") |> 
  select(variable_name, definition)

comm_cols <- 
  comm_master |> 
  pull(variable_name)
```

```{r}
comm_long <- 
  tbl |>
  select(country_code, is_hbc, who_dx_gap, pop_100k, all_of(comm_cols)) |> 
  pivot_longer(
    cols = all_of(comm_cols), 
    names_to = "variable_name", 
    values_to = "comm_value"
  ) |>
  mutate(comm_units_100k = comm_value / pop_100k) |> 
  left_join(comm_master, join_by(variable_name)) |> 
  mutate(definition = str_squish(str_remove(definition, "\\(.+\\)")))
```


### Density distribution

```{r fig.height=15, fig.width=12}
plot_density(
  comm_long,
  comm_units_100k,
  is_hbc,
  params$year,
  "Community data in",
  "Source: WHO"
) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") 
```

### Dx Gap

```{r fig.height=15, fig.width=12}
plot_scatter(
  comm_long,
  comm_units_100k,
  who_dx_gap,
  params$year,
  is_hbc,
  "Community data in",
  "Source: WHO"
) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") 
```

## Laboratories

```{r}
labs_master <- 
  dxgap_master_list |> 
  filter(dataset == "laboratories") |> 
  select(variable_name, definition)

labs_cols <- 
  labs_master |> 
  pull(variable_name)
```

```{r}
sites_long <- 
  tbl |> 
  select(country_code, is_hbc, who_dx_gap, pop_100k, all_of(labs_cols)) |> 
  pivot_longer(
    cols = -c(country_code, is_hbc, who_dx_gap, pop_100k), 
    names_to = "lab_type",
    values_to = "lab_numb"
  ) |> 
  mutate(lab_per_100k = lab_numb / pop_100k) |> 
  left_join(labs_master, by = join_by(lab_type == variable_name)) 
```

### Density distribution

```{r fig.height=15, fig.width=12}
plot_density(
  sites_long,
  lab_per_100k,
  is_hbc,
  params$year,
  "Community data in",
  "Source: WHO"
) +
  facet_wrap(vars(definition), ncol = 2, scales = "free")
```

### Dx Gap

```{r fig.height=15, fig.width=12}
plot_scatter(
  sites_long_complete,
  lab_per_100k,
  who_dx_gap,
  params$year, 
  is_hbc,
  "Labs and site data in",
  "Source: WHO"
) +
  facet_wrap(vars(definition), ncol = 2, scales = "free")
```

## Devices

### Density distribution

```{r}
plot_density(
  tbl,
  total_numb_device,
  is_hbc,
  params$year, 
  "TB diagnostic devices in",
  "Source: Global Fund"
)
```

### Dx Gap

```{r}
plot_scatter(
  tbl,
  total_numb_device,
  who_dx_gap,
  params$year, 
  is_hbc,
  "TB diagnostic devices in",
  "Source: Global Fund"
)
```

## Expenditures

```{r}
exp_master <- 
  dxgap_master_list |> 
  filter(dataset == "expenditure_and_utilisation") |> 
  select(variable_name, definition)

exp_cols <- 
  exp_master |> 
  pull(variable_name)
```

```{r}
exp_long <- 
  tbl |> 
  select(country_code, is_hbc, who_dx_gap, pop_100k, all_of(exp_cols)) |> 
  pivot_longer(
    cols = -c(country_code, is_hbc, who_dx_gap, pop_100k), 
    names_to = "exp_type",
    values_to = "exp_numb"
  ) |> 
  mutate(exp_per_100k = exp_numb / pop_100k) |> 
  left_join(exp_master, by = join_by(exp_type == variable_name)) 
```

### Density distribution

```{r fig.height=15, fig.width=12}
plot_density(
  exp_long,
  exp_per_100k,
  is_hbc,
  params$year,
  "Community data in",
  "Source: WHO"
) +
  facet_wrap(vars(definition), ncol = 2, scales = "free")
```

### Dx Gap

```{r fig.height=15, fig.width=12}
plot_scatter(
  exp_long,
  exp_per_100k,
  who_dx_gap,
  params$year, 
  is_hbc,
  "Labs and site data in",
  "Source: WHO"
) +
  facet_wrap(vars(definition), ncol = 2, scales = "free")
```
