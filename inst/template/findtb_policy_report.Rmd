---
title: "Findtb Policy Report"
output: html_document
date: "`r Sys.Date()`"
params:
  dm: dm
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
pkgload::load_all()
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
dm <- params$dm
```

```{r}
dm::dm_draw(dm)
```


```{r}
# data_list <- findtb_load(.year = 2019)
# dm <- findtb_build_dm(data_list)
tbl <- 
  dm::dm_flatten_to_tbl(dm, .start = hbc) |> 
  rename(
    tb_estimated_cases = e_inc_num,
    tb_notified_cases = c_newinc,
    sites_culture = culture,
    sites_smear = smear,
    sites_xpert = xpert
  ) |> 
  mutate(
    who_dx_gap = (tb_estimated_cases - tb_notified_cases) / tb_estimated_cases,
    pop_100k = pop_total / 1e5
  )
```

```{r}
tbl |> 
  gt::gt()
```

## Dx Gap

```{r}
tbl |>
  ggplot(aes(who_dx_gap)) +
  geom_density(fill = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(x = "WHO's Dx Gap in 2019")
```


## Population

```{r}
tbl |>
  ggplot(aes(pop_100k)) +
  geom_density(fill = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = "Total population in 2019",
    caption = "Source: World Bank"
  )
```

## Population density

```{r}
tbl |>
  ggplot(aes(pop_density)) +
  geom_density(fill = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = "Population density (people per sq. km of land area) in 2019",
    caption = "Source: World Bank"
  )
```

## Population Urban

```{r}
tbl |> 
  mutate(country_code = forcats::fct_reorder(country_code, pop_urban_perc)) |> 
  ggplot(aes(country_code, pop_urban_perc)) +
  geom_col(fill = "steelblue") +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  theme_minimal() +
  coord_flip() +
    labs(
    x = "Urban population (% of total population) in 2019",
    caption = "Source: World Bank"
  )
```

```{r}
tbl |>
  ggplot(aes(pop_urban_perc)) +
  geom_density(fill = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = "Urban population (% of total population) in 2019",
    caption = "Source: World Bank"
  )
```

## Budget

```{r}
who_budget_dx_df |>
  ggplot(aes(budget_value, who_dx_gap)) +
  geom_point(colour = "steelblue", alpha = .8) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()

who_budget_dx_df |>
  pivot_wider(names_from = definition, values_from = budget_value) |>
  correlate() |>
  select(term, who_dx_gap) |>
  arrange(who_dx_gap) |>
  filter(term != "who_dx_gap")

who_budget_df |>
  ggplot(aes(budget_value)) +
  geom_density(fill = "steelblue", alpha = .5) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()

who_budget_dx_df <-
  who_budget_df |>
  select(-country) |>
  inner_join(dx_gap_df, join_by(country_code, year)) |>
  select(-all_of(c("budget_type", "year")))

# log budget per 100k pop ----
who_log_budget_df <-
  who_budget_df |>
  select(-country) |>
  inner_join(wb_tot_pop_df, by = join_by(country_code, year)) |>
  mutate(budget_per_100k = budget_value / pop_100k) |>
  mutate(log_budget_per_100k = log(budget_per_100k)) |>
  inner_join(dx_gap_df, join_by(country_code, year)) |>
  select(-all_of(c("budget_type", "year")))


who_log_budget_df |>
  ggplot(aes(log_budget_per_100k)) +
  geom_density(fill = "steelblue", alpha = .5) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()

who_log_budget_df |>
  select(country_code, who_dx_gap, log_budget_per_100k, definition) |>
  pivot_wider(names_from = definition, values_from = log_budget_per_100k) |>
  correlate() |>
  select(term, who_dx_gap) |>
  arrange(who_dx_gap) |>
  filter(term != "who_dx_gap")

who_log_budget_df |>
  ggplot(aes(log_budget_per_100k, who_dx_gap)) +
  geom_point(colour = "steelblue", alpha = .8) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

## Community

```{r}

community_complete_df <-
  who_community |>
  group_by(comm_type) |>
  summarise(n = n(), complete_rate = sum(!is.na(comm_value)) / n, .groups = "drop") |>
  filter(complete_rate > 0.7)

who_community |>
  semi_join(community_complete_df, by = join_by(comm_type)) |>
  left_join(findtb_master_list, by = join_by(comm_type == variable_name)) |>
  select(country_code, comm_value, definition)

```

## Sites

```{r}
who_sites |>
  ggplot(aes(sites_per_100k)) +
  geom_density(fill = "steelblue", alpha = .5) +
  facet_wrap(vars(site_type), scales = "free") +
  theme_minimal()

sites_complete_df <-
  who_sites |>
  group_by(site_type, year) |>
  summarise(n = n(), complete_rate = sum(!is.na(site_count)) / n, .groups = "drop") |>
  arrange(year) |>
  select(-n) |>
  filter(complete_rate > 0)
```

