---
title: "TB Policy Report"
output: html_document
date: "`r Sys.Date()`"
params:
  dm_hbc: dm_hbc
  dm_non_hbc: dm_non_hbc
  data_tbl: data_tbl
  year: year
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(corrr)
pkgload::load_all()
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, fig.align = "center", message = FALSE, warning = FALSE)
```

```{r}
dm_hbc <- params$dm_hbc
dm_non_hbc <- params$dm_non_hbc
data_tbl <- params$data_tbl
```

The chosen year is `r params$year`.

## Data model

```{r}
dm::dm_draw(dm_hbc)
```

## Data

```{r}
tbl <- 
  data_tbl |> 
  mutate(
    pop_100k = pop_total / 1e5,
    who_dx_gap = (e_inc_num - c_newinc) / e_inc_num,
  )
```

```{r}
tbl |> 
  gt::gt()
```

## Correlations

```{r}
corr_df <- 
  tbl |> 
  select(-country_code) |> 
  correlate() |>
  select(term, who_dx_gap) |>
  arrange(who_dx_gap) |>
  filter(term != "who_dx_gap")
```

```{r}
corr_df |> 
  left_join(
    select(findtb_master_list, variable_name, definition), 
    by = join_by(term == variable_name)
  ) |> 
  relocate(definition, term, who_dx_gap) |> 
  gt::gt()
```


## Dx Gap

```{r}
tbl |> 
  mutate(country_code = forcats::fct_reorder(country_code, who_dx_gap)) |> 
  ggplot(aes(country_code, who_dx_gap)) +
  geom_col(fill = "steelblue") +
  theme_minimal() +
  coord_flip() +
    labs(
    y = paste("Dx Gap in", params$year),
    caption = "Source: WHO"
  )
```


```{r}
tbl |>
  ggplot(aes(who_dx_gap)) +
  geom_density(fill = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(x = paste("Dx Gap in", params$year), caption = "Source: WHO")
```

```{r}
tbl |> 
  mutate(c_cdr = c_cdr / 100) |> 
  ggplot(aes(c_cdr, who_dx_gap)) +
  geom_point(color = "steelblue", alpha = .5) +
  coord_fixed() +
  theme_minimal()
```


## Population total

```{r}
tbl |> 
  mutate(country_code = forcats::fct_reorder(country_code, pop_100k)) |> 
  ggplot(aes(country_code, pop_100k)) +
  geom_col(fill = "steelblue") +
  theme_minimal() +
  coord_flip() +
    labs(
    y = paste("Total population per 100k in", params$year),
    caption = "Source: World Bank"
  )
```

```{r}
tbl |>
  ggplot(aes(pop_100k)) +
  geom_density(fill = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = paste("Total population in", params$year),
    caption = "Source: World Bank"
  )
```

## Population density

### Bar chart

```{r}
tbl |> 
  # mutate(country_code = forcats::fct_reorder(country_code, pop_density)) |> # FIXME: with year 2021
  ggplot(aes(country_code, pop_density)) +
  geom_col(fill = "steelblue") +
  theme_minimal() +
  coord_flip() +
    labs(
    y = paste("Population density (people per sq. km of land area) in", params$year),
    caption = "Source: World Bank"
  )
```

### Density distrbution

```{r}
tbl |>
  ggplot(aes(pop_density)) +
  geom_density(fill = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = paste("Population density (people per sq. km of land area) in", params$year),
    caption = "Source: World Bank"
  )
```

### Dx Gap

```{r}
tbl |>
  ggplot(aes(pop_density, who_dx_gap)) +
  geom_point(color = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = paste("Population density (people per sq. km of land area) in", params$year),
    caption = "Source: World Bank"
  )
```

## Population urban

### Bar chart

```{r}
tbl |> 
  mutate(country_code = forcats::fct_reorder(country_code, pop_urban_perc)) |> 
  ggplot(aes(country_code, pop_urban_perc)) +
  geom_col(fill = "steelblue") +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  theme_minimal() +
  coord_flip() +
    labs(
    y = paste("Urban population (% of total population) in", params$year),
    caption = "Source: World Bank"
  )
```

### Density distribution

```{r}
tbl |>
  ggplot(aes(pop_urban_perc)) +
  geom_density(fill = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = paste("Urban population (% of total population) in", params$year),
    caption = "Source: World Bank"
  )
```

### Dx Gap

```{r}
tbl |>
  ggplot(aes(pop_urban_perc, who_dx_gap)) +
  geom_point(color = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = paste("Urban population (% of total population) in", params$year),
    caption = "Source: World Bank"
  )
```

## GDP

### Bar chart

```{r}
tbl |> 
  mutate(country_code = forcats::fct_reorder(country_code, gdp, .na_rm = FALSE)) |>
  ggplot(aes(country_code, gdp)) +
  geom_col(fill = "steelblue") +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  theme_minimal() +
  coord_flip() +
    labs(
    y = paste("GDP (current US$) in", params$year),
    caption = "Source: World Bank"
  )
```

### Density distribution

```{r}
tbl |>
  ggplot(aes(gdp)) +
  geom_density(fill = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = paste("GDP (current US$) in", params$year),
    caption = "Source: World Bank"
  )
```

### Dx Gap

```{r}
tbl |>
  ggplot(aes(gdp / pop_100k, who_dx_gap)) +
  geom_point(color = "steelblue", alpha = .5) +
  theme_minimal() +
  labs(
    x = paste("GDP (current US$) per 100k in", params$year),
    caption = "Source: World Bank"
  )
```

## Budget

```{r}
budget_master <- 
  findtb_master_list |> 
  filter(dataset == "budget") |> 
  select(variable_name, definition)

budget_cols <- 
  budget_master |> 
  pull(variable_name)
```

```{r}
budget_long <- 
  tbl |>
  select(country_code, who_dx_gap, pop_100k, all_of(budget_cols)) |> 
  pivot_longer(
    cols = all_of(budget_cols), 
    names_to = "budget_type", 
    values_to = "budget_value"
  ) |> 
  mutate(budget_per_100k = budget_value / pop_100k) |> 
  left_join(budget_master, join_by(budget_type == variable_name)) |> 
  mutate(definition = str_squish(str_remove(definition, "\\(.+\\)")))
```

### Completion rate

```{r}
complete_budget_df <- 
  budget_long |>
  group_by(budget_type, definition) |>
  summarise(
    n = n(), 
    complete_rate = sum(!is.na(budget_value)) / n, 
    .groups = "drop"
  ) |>
  select(-n)
```

```{r}
complete_budget_df |> 
  relocate(definition, budget_type, complete_rate) |> 
  arrange(desc(complete_rate)) |>
  gt::gt()
```

```{r}
budget_complete_long <- 
  budget_long |> 
  semi_join(complete_budget_df, by = join_by(budget_type))
```

### Bar chart

```{r fig.height=15, fig.width=12}
budget_complete_long |> 
  mutate(
    country_code = forcats::fct_reorder(country_code, budget_per_100k, .na_rm = TRUE)
  ) |> 
  ggplot(aes(country_code, budget_per_100k, fill = "steelblue")) +
  geom_col() +
  scale_fill_manual(values = "steelblue") +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  coord_flip() +
  theme_minimal() +
  guides(fill = "none") +
  labs(caption = "Source: Global Fund")
```

### Density distribution

```{r fig.height=15, fig.width=12}
budget_long |>
  ggplot(aes(budget_per_100k)) +
  geom_density(fill = "steelblue", alpha = .5) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

### Dx Gap

```{r fig.height=15, fig.width=12}
budget_long |> 
  ggplot(aes(budget_per_100k, who_dx_gap)) +
  geom_point(colour = "steelblue", alpha = .8) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

```{r eval=FALSE}
budget_long_log <- 
  tbl |>
  select(country_code, who_dx_gap, pop_100k, all_of(budget_cols)) |> 
  pivot_longer(
    cols = all_of(budget_cols), 
    names_to = "variable_name", 
    values_to = "budget_value"
  ) |> 
  transmute(
    country_code,
    variable_name,
    budget_per_100k = budget_value / pop_100k,
    log_budget_per_100k = log(budget_per_100k),
    who_dx_gap
  ) |> 
  left_join(budget_master, join_by(variable_name)) |> 
  mutate(definition = str_squish(str_remove(definition, "\\(.+\\)")))
```

```{r eval=FALSE}
budget_long_log |> 
  mutate(
    country_code = forcats::fct_reorder(country_code, budget_per_100k, .na_rm = TRUE)
  ) |> 
  ggplot(aes(country_code, budget_per_100k)) +
  geom_col() +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  coord_flip() +
  theme_minimal()
```

```{r eval=FALSE, fig.height=15, fig.width=12}
budget_long_log |>
  ggplot(aes(log_budget_per_100k)) +
  geom_density(fill = "steelblue", alpha = .5) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

```{r eval=FALSE, fig.height=15, fig.width=12}
budget_long_log |>
  ggplot(aes(log_budget_per_100k, who_dx_gap)) +
  geom_point(colour = "steelblue", alpha = .8) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

## Community

```{r}
comm_master <- 
  findtb_master_list |> 
  filter(dataset == "community_engagement") |> 
  select(variable_name, definition)

comm_cols <- 
  comm_master |> 
  pull(variable_name)
```

```{r}
comm_long <- 
  tbl |>
  select(country_code, who_dx_gap, pop_100k, all_of(comm_cols)) |> 
  pivot_longer(
    cols = all_of(comm_cols), 
    names_to = "variable_name", 
    values_to = "comm_value"
  ) |>
  mutate(comm_units_100k = comm_value / pop_100k) |> 
  left_join(comm_master, join_by(variable_name)) |> 
  mutate(definition = str_squish(str_remove(definition, "\\(.+\\)")))
```

```{r}
community_complete_df <-
  comm_long |>
  group_by(definition, variable_name) |>
  summarise(
    n = n(), 
    complete_rate = sum(!is.na(comm_value)) / n, 
    .groups = "drop"
  ) |> 
  select(-n)
```

### Completion rate

```{r}
community_complete_df |> 
  gt::gt()
```


```{r}
comm_long <- 
  comm_long |>
  semi_join(
    filter(community_complete_df, complete_rate > 0), 
    by = join_by(variable_name)
  ) 
```

### Bar chart

```{r fig.height=15, fig.width=12}
comm_long |>
  # mutate( # FIXME
  #   country_code = forcats::fct_reorder(country_code, comm_units_100k, .na_rm = TRUE)
  # ) |>
  ggplot(aes(country_code, comm_units_100k, fill = "steelblue")) +
  geom_col() +
  scale_fill_manual(values = "steelblue") +
  coord_flip() +
  guides(fill = "none") +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

### Density distribution

```{r fig.height=15, fig.width=12}
comm_long |>
  ggplot(aes(comm_units_100k)) +
  geom_density(fill = "steelblue", alpha = .5) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

### Dx Gap

```{r fig.height=15, fig.width=12}
comm_long |>
  ggplot(aes(comm_units_100k, who_dx_gap)) +
  geom_point(colour = "steelblue", alpha = .8) +
  facet_wrap(vars(definition), ncol = 2, scales = "free") +
  theme_minimal()
```

## Laboratories

```{r}
labs_master <- 
  findtb_master_list |> 
  filter(dataset == "laboratories") |> 
  select(variable_name, definition)

labs_cols <- 
  labs_master |> 
  pull(variable_name)
```

```{r}
sites_long <- 
  tbl |> 
  select(country_code, who_dx_gap, pop_100k, all_of(labs_cols)) |> 
  pivot_longer(
    cols = -c(country_code, who_dx_gap, pop_100k), 
    names_to = "lab_type",
    values_to = "lab_numb"
  ) |> 
  mutate(lab_per_100k = lab_numb / pop_100k) |> 
  left_join(labs_master, by = join_by(lab_type == variable_name)) 
```

```{r}
complete_site_df <- 
  sites_long |>
  group_by(definition, lab_type) |>
  summarise(
    n = n(), 
    complete_rate = sum(!is.na(lab_numb)) / n, 
    .groups = "drop"
  ) |>
  select(-n)
```


### Completion rate

```{r}
complete_site_df |> 
  arrange(desc(complete_rate)) |> 
  gt::gt()
```

```{r}
sites_long_complete <- 
  sites_long |> 
  semi_join(
    filter(complete_site_df, complete_rate > 0.75),
    by = join_by(lab_type)
  ) 
```

### Density distribution

```{r fig.height=10, fig.width=12}
sites_long_complete |> 
  ggplot(aes(lab_per_100k)) +
  geom_density(fill = "steelblue", alpha = .5) +
  facet_wrap(vars(definition), ncol = 1, scales = "free") +
  theme_minimal()
```

### Dx Gap

```{r fig.height=10, fig.width=12}
sites_long_complete |> 
  ggplot(aes(lab_per_100k, who_dx_gap)) +
  geom_point(color = "steelblue", alpha = .5) +
  facet_wrap(vars(definition), ncol = 1, scales = "free") +
  theme_minimal()
```



```{r}
complete_only_df <- 
  tbl |> 
  pivot_longer(cols = -country_code, names_to = "variable") |> 
  group_by(variable) |> 
  summarise(
    n = n(), 
    complete_rate = sum(!is.na(value)) / n, 
    .groups = "drop"
  ) |>
  select(-n) |> 
  filter(complete_rate == 1)
```

```{r eval=FALSE}
tbl_complete <- 
  tbl |> 
  pivot_longer(cols = -country_code, names_to = "variable") |> 
  semi_join(complete_only_df, by = join_by(variable)) |> 
  pivot_wider(names_from = variable, values_from = value) |> 
  transmute(
    country_code,
    who_dx_gap,
    pop_100k,
    pop_urban_perc,
    pop_density,
    budget_lab_100k = budget_lab / pop_100k,
    budget_staff_100k = budget_staff / pop_100k,
    cf_tot_domestic_100k = cf_tot_domestic / pop_100k,
    cf_tot_sources_100k = cf_tot_sources / pop_100k,
    culture_100k = culture / pop_100k,
    smear_100k = smear / pop_100k,
    xpert_100k = xpert / pop_100k
  ) 
```

```{r eval=FALSE}
tbl_split <- rsample::initial_split(tbl_complete)
tbl_train <- rsample::training(tbl_split)
tbl_test <- rsample::testing(tbl_split)
```

```{r eval=FALSE}
tbl_rec <- 
  recipes::recipe(who_dx_gap ~ ., data = tbl_train) |>
  recipes::update_role(country_code, new_role = "ID") |>
  recipes::step_normalize(recipes::all_numeric(), -recipes::all_outcomes())
```

```{r eval=FALSE}
lasso_spec <- 
  parsnip::linear_reg(penalty = 0.1, mixture = 1) |> 
  parsnip::set_engine("glmnet")
```

```{r eval=FALSE}
wf <- 
  workflows::workflow() |> 
  workflows::add_recipe(tbl_rec)
```

```{r eval=FALSE}
lasso_fit <- 
  wf |>
  workflows::add_model(lasso_spec) |>
  parsnip::fit(data = tbl_train)
```

```{r eval=FALSE}
lasso_fit  |> 
  workflows::extract_fit_parsnip() |> 
  broom::tidy()
```

```{r eval=FALSE}
set.seed(1234)
tbl_boot <- rsample::bootstraps(tbl_train)

tune_spec <- 
  parsnip::linear_reg(penalty = tune::tune(), mixture = 1) |> 
  parsnip::set_engine("glmnet")

lambda_grid <- dials::grid_regular(dials::penalty(), levels = 10)
```

```{r eval=FALSE}
set.seed(2020)
lasso_grid <- 
  tune::tune_grid(
    wf |> workflows::add_model(tune_spec),
    resamples = tbl_boot,
    grid = lambda_grid
  )
```

```{r eval=FALSE}
lasso_grid |> 
  tune::collect_metrics()
```

```{r eval=FALSE}
lasso_grid |>
  tune::collect_metrics() |>
  ggplot(aes(penalty, mean, color = .metric)) +
  geom_errorbar(aes(
    ymin = mean - std_err,
    ymax = mean + std_err
  ),
  alpha = 0.5
  ) +
  geom_line(linewidth = 1.5) +
  facet_wrap(~ .metric, scales = "free", nrow = 2) +
  scale_x_log10() +
  theme(legend.position = "none")
```

```{r eval=FALSE}
lowest_rmse <- 
  lasso_grid |> 
  tune::collect_metrics() |> 
  filter(.metric == "rmse", penalty != 1) |> 
  filter(mean == min(mean)) 
```


```{r eval=FALSE}
final_lasso <- 
  tune::finalize_workflow(
    wf |>  workflows::add_model(tune_spec),
    lowest_rmse
  )
```

```{r eval=FALSE}
final_lasso |> 
  parsnip::fit(tbl_train) |> 
  workflows::extract_fit_parsnip() |> 
  vip::vi(lambda = lowest_rmse$penalty) |>
  mutate(
    Importance = abs(Importance),
    Variable = fct_reorder(Variable, Importance)
  ) %>%
  ggplot(aes(x = Importance, y = Variable, fill = Sign)) +
  geom_col() +
  scale_x_continuous(expand = c(0, 0)) +
  labs(y = NULL)
```


```{r eval=FALSE}
tune::last_fit(
  final_lasso,
  tbl_split
) %>%
  tune::collect_metrics()
```

## Final model

$dx\_gap = \beta_0 + \beta_1culture\_100k$

```{r}
tbl_mod <- 
  tbl |> 
  mutate(culture_100k = culture / pop_100k)
lm_mod <- lm(who_dx_gap ~ culture_100k, data = tbl_mod)
```

```{r}
broom::tidy(lm_mod) |> 
  gt::gt()
```

