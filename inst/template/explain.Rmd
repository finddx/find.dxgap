---
title: "Explain"
output: html_document
date: "`r Sys.Date()`"
params:
  dm_hbc: dm_hbc
  dm_non_hbc: dm_non_hbc
  data_tbl: data_tbl
  year: year
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(recipes)
pkgload::load_all()
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, fig.align = "center", message = FALSE, warning = FALSE)
```


```{r params}
year <- params$year
data_tbl <- params$data_tbl
```

The chosen year is `r params$year`.

```{r data}
tbl <- 
  data_tbl |> 
  compute_dx_gap()
```


```{r spending}
tbl_split <- rsample::initial_split(tbl)
tbl_train <- rsample::training(tbl_split)
tbl_test <- rsample::testing(tbl_split)
```

```{r bootstrap}
tbl_boot <- rsample::bootstraps(tbl_train)
```

```{r rec-core}
rec_core <- get_core_recipe(tbl)
```

```{r eval=FALSE}
rec_core |> 
  cook()
```


```{r rec-log}
rec_log <- 
  rec_core |> 
  step_mutate_at(
    all_numeric_predictors(), fn = ~ dplyr::if_else(.x == 0, 1, .x)
  ) |> 
  step_log(all_numeric_predictors())
```

```{r}
rec_norm <- 
  rec_core |> 
  recipes::step_normalize(all_numeric_predictors())
```

```{r}
rec_pop_100k <- 
  rec_core |> 
  step_mutate_at(
    all_numeric_predictors(), -has_role("no_norm"), fn = ~ .x / pop_100k
  ) 
```

```{r eval=FALSE}
rec_pca <- 
  rec_core |> 
   step_pca(all_numeric_predictors(), num_comp = tune::tune()) %>% 
   step_normalize(all_predictors())
```


```{r lm}
lm_model <-
  parsnip::linear_reg(mode = "regression") %>%
  parsnip::set_engine("lm")
```

```{r lasso}
set.seed(2020)
lasso_model <- 
  parsnip::linear_reg(penalty = tune::tune(), mixture = 1) |> 
  parsnip::set_engine("glmnet")
lambda_grid <- dials::grid_regular(dials::penalty(), levels = 10)
```

```{r combo}
models <- list(lm = lm_model, lasso = lasso_model)
preproc <- list(
  simple = rec_core, 
  log = rec_log, 
  norm = rec_norm, 
  pop_100k = rec_pop_100k
)
```

```{r set}
linear_models <- 
   workflowsets::workflow_set(
      preproc = preproc,
      models = models
   )
```

```{r fit}
fit <- 
  workflowsets::workflow_map(
    linear_models, 
    fn = "tune_grid",
    resamples = tbl_boot,
    grid = lambda_grid,
    verbose = TRUE
  ) 
```

```{r}
workflowsets::rank_results(fit, rank_metric = "rmse", select_best = TRUE) |> 
  select(rank, mean, model, wflow_id, .config) |> 
  gt::gt()
```


```{r assess}
autoplot(fit)
```


```{r eval=FALSE}
wf <-
  workflows::workflow() |>
  workflows::add_model(lm_model) |>
  workflows::add_recipe(rec_core_prep) 
```

```{r eval=FALSE}
lm_fit <- parsnip::fit(linear_models, data = tbl)
```

```{r eval=FALSE}
lm_fit  |>
  workflows::extract_fit_parsnip() |>
  broom::tidy() |> 
  mutate(p.value = round(p.value, 3)) |> 
  gt::gt() |> 
  gt::data_color(
    rows = p.value < 0.05,
    palette = "red"
  )
```


