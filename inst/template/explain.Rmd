---
title: "TB Policy Report"
output: html_document
date: "`r Sys.Date()`"
params:
  data_tbl: data_tbl
  year: year
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(recipes)
pkgload::load_all()
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, fig.align = "center", message = FALSE, warning = FALSE)
```


```{r}
year <- params$year
data_tbl <- params$data_tbl
```

The chosen year is `r params$year`.

```{r}
tbl <- 
  data_tbl |> 
  mutate(who_dx_gap = (e_inc_num - c_newinc) / e_inc_num) 
```


```{r}
tbl_rec <-
  recipe(formula = who_dx_gap ~ ., x = tbl) |>
  update_role(who_dx_gap, new_role = "outcome") |>
  update_role(country_code, new_role = "id") |>
  step_filter_missing(all_predictors(), threshold = 0.9) |> 
  update_role(
    dplyr::all_of(
      c("c_cdr", "c_newinc_100k", 
        "e_mort_100k", "e_pop_num", "new_labconf", "is_hbc")
    ),  
    new_role = "collinear"
  ) |>
  update_role(
    dplyr::all_of(c("pop_urban_perc", "pop_density")), 
    new_role = "no_norm"
  ) |>
  update_role(
    dplyr::all_of(
      c("e_inc_100k", "e_inc_num", "c_newinc", "pop_total", 
        "pop_density", "pop_urban_perc", "gdp")
    ),  
    new_role = "impute_w_median"
  ) |>
  step_impute_median(has_role("impute_w_median")) |> 
  step_mutate(pop_100k = pop_total / 1e5) |> 
  step_rm(has_role("collinear")) |>
  step_rm(removals = c("c_newinc", "e_inc_num")) |> 
  cook() |> 
  glimpse()
  step_impute_knn(
    all_predictors(),
    neighbors = 5,
    impute_with = imp_vars(has_role("impute_w_median"))
  ) |>
  step_mutate_at(
    all_numeric_predictors(), -has_role("no_norm"), fn = ~ .x / pop_100k
  ) |>
  step_mutate_at(
    all_numeric_predictors(), fn = ~ dplyr::if_else(.x == 0, 1, .x)
  ) |> 
  step_log(all_numeric_predictors(), has_role("outcome")) |>
  step_zv(all_numeric_predictors()) |> 
  step_rm(country_code)
```

```{r}
lm_model <-
  parsnip::linear_reg(mode = "regression") %>%
  parsnip::set_engine("lm")
```

```{r}
wf <-
  workflows::workflow() |>
  workflows::add_model(lm_model) |>
  workflows::add_recipe(tbl_rec)
```

```{r}
lm_fit <- parsnip::fit(wf, data = tbl)
```


```{r}
lm_fit  |>
  workflows::extract_fit_parsnip() |>
  broom::tidy()
```


